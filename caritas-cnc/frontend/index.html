<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ================== META ================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>C√°ritas CNC</title>

  <!-- ================== ESTILOS ================== -->
  <link rel="stylesheet" href="styles.css" />

  <!-- ================== ICONOS ================== -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- ================== MAPAS (Leaflet) ================== -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- ================== QR Code ================== -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- ================== SUPABASE ================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const supabaseClient = supabase.createClient(
      "https://qivjlsvcjyqymommfdke.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw"
    );
  </script>
</head>

<body>
  <!-- ================== HEADER / NAVEGACI√ìN ================== -->
  <header class="app-header">
    <h1><i class="fas fa-church"></i> C√°ritas CNC</h1>
    <nav>
      <button type="button" onclick="showSection('inicio')" class="tabbtn">Inicio</button>
      <button type="button" onclick="showSection('credenciales')" class="tabbtn">Credenciales</button>
      <button type="button" onclick="showSection('registro')" class="tabbtn">Registro</button>
      <button type="button" onclick="showSection('login')" id="btn-login">Iniciar sesi√≥n</button>
      <button type="button" id="btn-logout" style="display:none" onclick="logout()">Cerrar sesi√≥n</button>
    </nav>
  </header>

  <!-- ================== MAIN ================== -->
  <main>

    <!-- ====== SECCI√ìN: INICIO ====== -->
    <section id="inicio" class="seccion active">
      <div class="inicio-card">
        <h2>Bienvenido a C√°ritas CNC ‚ù§Ô∏è</h2>
        <p>Plataforma de gesti√≥n para el voluntariado de C√°ritas CNC.</p>
        <p>Desde aqu√≠ puedes registrar nuevas familias, gestionar credenciales y acceder a la agenda.</p>
      </div>
    </section>

    <!-- ====== SECCI√ìN: CREDENCIALES ====== -->
    <section id="credenciales" class="seccion">
      <h2>Credenciales</h2>

      <!-- Crear Credencial -->
      <div class="card">
        <h3>Crear Credencial</h3>
        <input type="email" id="cred-email" placeholder="Correo electr√≥nico" />
        <input type="password" id="cred-password" placeholder="Contrase√±a" />
        <input type="file" id="foto-perfil" accept="image/*" />
        <button id="btn-crear-credencial" class="btn-big">Crear credencial</button>
        <canvas id="qr-canvas"></canvas>
        <button id="btn-ver-credencial" style="display:none;">
          <i class="fa-solid fa-id-card"></i> Ver Credencial
        </button>
      </div>

      <!-- Validar Credencial -->
      <div class="card">
        <h3>Validar Credencial</h3>
        <button id="btn-ver-credencial-secundario" class="submit-btn">
          <i class="fa-solid fa-id-card"></i> Ver Credencial
        </button>
      </div>
    </section>

    <!-- ====== SECCI√ìN: REGISTRO DE FAMILIAS ====== -->
    <section id="registro" class="seccion">
      <h2>Registro de Familias</h2>
      <div id="msg"></div>

      <form id="familiaForm" enctype="multipart/form-data" class="card">
        <label>Nombres y Apellidos*</label>
        <input type="text" name="nombres_apellidos" required />

        <label>DNI*</label>
        <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />

        <label>Apellido Familia*</label>
        <input type="text" name="apellido_familia" required />

        <label>Direcci√≥n*</label>
        <input type="text" name="direccion" required />

        <label>Fecha de Registro*</label>
        <input type="date" name="fecha_registro" required />

        <label>Tel√©fono*</label>
        <input type="text" name="telefono_contacto" pattern="[0-9]+" required />

        <label>Observaciones</label>
        <textarea name="observaciones"></textarea>

        <button type="submit" class="submit-btn">Registrar</button>
      </form>
    </section>

    <!-- ====== SECCI√ìN: LOGIN ====== -->
    <section id="login" class="seccion">
      <h2>Iniciar Sesi√≥n</h2>
      <form id="loginForm" class="card">
        <input type="email" id="email" placeholder="Correo electr√≥nico" required />
        <input type="password" id="password" placeholder="Contrase√±a" required />
        <button type="submit" class="submit-btn">Entrar</button>
        <button type="button" onclick="resetPass()">¬øOlvidaste tu contrase√±a?</button>
      </form>
      <div id="loginMessage"></div>
    </section>
  </main>

  <!-- ================== FOOTER ================== -->
  <footer>¬© 2025 C√°ritas CNC. Todos los derechos reservados.</footer>

<!-- ================== SCRIPTS FUNCIONALES ================== -->
<script type="module">
  /* ====== Inicializar Firebase ====== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD5X6LUG_dOwuaUf6jQUHw_LM5PFgOmc40",
    authDomain: "web-familias.firebaseapp.com",
    projectId: "web-familias",
    storageBucket: "web-familias.firebasestorage.app",
    messagingSenderId: "261699620792",
    appId: "1:261699620792:web:8ff59afb72e96c371dc94d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  /* ====== Funciones de Credenciales con Supabase ====== */
  async function guardarCredencial(usuario, clave) {
    const { error } = await supabaseClient.from('credenciales').insert([{ usuario, clave }]);
    if (error) throw error;
  }

  async function validarCredencial(usuario, clave) {
    const { data, error } = await supabaseClient
      .from('credenciales')
      .select('*')
      .eq('usuario', usuario)
      .eq('clave', clave);
    if (error) throw error;
    return data.length > 0;
  }

  /* ====== Bot√≥n Crear Credencial ====== */
  document.getElementById("btn-crear-credencial")?.addEventListener("click", async () => {
    const email = document.getElementById("cred-email").value.trim();
    const password = document.getElementById("cred-password").value.trim();
    if (!email || !password) {
      alert("‚ö† Ingresa correo y contrase√±a");
      return;
    }
    try {
      await guardarCredencial(email, password);
      const canvas = document.getElementById("qr-canvas");
      await QRCode.toCanvas(canvas, email, { width: 180 });
      document.getElementById("btn-ver-credencial").style.display = "inline-block";
      alert("‚úÖ Credencial creada con √©xito");
    } catch (err) {
      alert("‚ùå No se pudo crear la credencial");
    }
  });

  document.getElementById("btn-ver-credencial-secundario")?.addEventListener("click", async () => {
    const email = prompt("Correo:");
    const password = prompt("Contrase√±a:");
    const valido = await validarCredencial(email, password);
    alert(valido ? "‚úî Credencial v√°lida" : "‚ùå Credencial inv√°lida");
  });

  /* ====== Registro de Familias en Supabase ====== */
  document.getElementById('familiaForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const msgDiv = document.getElementById('msg');
    msgDiv.innerHTML = '';
    const formData = new FormData(this);
    const familia = {
      nombres_apellidos: formData.get("nombres_apellidos"),
      dni_solicitante: formData.get("dni_solicitante"),
      apellido_familia: formData.get("apellido_familia"),
      direccion: formData.get("direccion"),
      fecha_registro: formData.get("fecha_registro"),
      telefono_contacto: formData.get("telefono_contacto"),
      observaciones: formData.get("observaciones") || null
    };
    try {
      const { error } = await supabaseClient.from("familias").insert([familia]);
      if (error) throw error;
      msgDiv.innerHTML = "<div class='success'>‚úÖ Registro exitoso</div>";
      this.reset();
    } catch (err) {
      msgDiv.innerHTML = "<div class='error'>‚ùå Error al registrar: " + err.message + "</div>";
    }
  });

  /* ====== Login con Firebase ====== */
  document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('loginMessage');
    msg.textContent = '';
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      msg.style.color = '#0a7b2e';
      msg.textContent = '‚úî Acceso concedido';
      document.getElementById("btn-login").style.display = "none";
      document.getElementById("btn-logout").style.display = "inline-block";
      showSection('inicio');
    } catch (err) {
      msg.style.color = '#b00020';
      msg.textContent = '‚ùå ' + (err?.message || 'Error');
    }
  });

  async function resetPass() {
    const email = prompt('Ingresa tu correo:');
    if (!email) return;
    try {
      await sendPasswordResetEmail(auth, email);
      alert('üì© Hemos enviado un enlace de recuperaci√≥n si el correo existe.');
    } catch (err) {
      alert('‚ùå Error al enviar el correo de recuperaci√≥n.');
    }
  }

  async function logout() {
    await signOut(auth);
    alert("üëã Sesi√≥n cerrada");
    document.getElementById("btn-login").style.display = "inline-block";
    document.getElementById("btn-logout").style.display = "none";
    showSection("inicio");
  }

  /* ====== Navegaci√≥n entre Secciones ====== */
  window.showSection = function(id) {
    document.querySelectorAll('.seccion').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
  };
</script>
</body>
</html>
