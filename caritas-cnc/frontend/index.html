<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°ritas CNC - Registro de Familias</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b71c1c">
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
</head>
<body>

<header>C√°ritas CNC - Registro y Listado de Familias</header>

<nav>
  <button onclick="showSection('inicio')">Inicio</button>
  <button onclick="showSection('registro')">Registro</button>
  <button onclick="showSection('contacto')">Contacto</button>
  <button onclick="showSection('administracion')">Administraci√≥n</button>
</nav>

<section id="inicio" class="active">
  <h2>Bienvenido ‚ù§Ô∏è</h2>
  <p>Gracias por usar <b>C√°ritas CNC</b> para ayudar a las familias necesitadas.</p>
  <br />
  <button class="submit-btn" onclick="goToListado()">üìã Ver Listado de Familias</button>
</section>

<section id="registro">
  <h2>Registro de Familias</h2>
  <div id="msg"></div>
  <form id="familiaForm" enctype="multipart/form-data">
    <label>Nombres y Apellidos*</label>
    <input type="text" name="nombres_apellidos" required />
    <label>DNI*</label>
    <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />
    <label>Apellido Familia*</label>
    <input type="text" name="apellido_familia" required />
    <label>Direcci√≥n*</label>
    <input type="text" name="direccion" required />
    <label>Fecha de Registro*</label>
    <input type="date" name="fecha_registro" required />
    <label>Tel√©fono*</label>
    <input type="text" name="telefono_contacto" pattern="[0-9]+" required />
    <label>Observaciones</label>
    <textarea name="observaciones"></textarea>
    <label>Adjuntar documento</label>
    <input type="file" name="archivo" accept=".pdf,.jpg,.png" />
    <label><input type="checkbox" required> Acepto los t√©rminos y condiciones</label>
    <button type="submit" class="submit-btn">Registrar</button>
  </form>
</section>

<section id="listado" style="display:none;">
  <h2>Listado de Familias</h2>
  <input type="text" id="search" placeholder="Buscar familia...">
  <table id="familiasTable">
    <thead>
      <tr>
        <th>Nombres</th>
        <th>DNI</th>
        <th>Apellido</th>
        <th>Direcci√≥n</th>
        <th>Fecha</th>
        <th>Tel√©fono</th>
        <th>Observaciones</th>
        <th>Mapa</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="mapContainer" style="margin-top:20px;"></div>
  <br />
  <button class="submit-btn" onclick="logout()">Cerrar Sesi√≥n</button>
</section>

<section id="contacto">
  <h2>Contacto</h2>
  <p>Email: contacto@caritas.org</p>
  <p>Tel√©fono: +51 999 888 777</p>
</section>

<section id="administracion">
  <h2>Administraci√≥n</h2>
  <button onclick="showSubSection('agendamiento')">üìÖ Agendamiento</button>
  <div id="agendamiento" class="subsection" style="display:none;">
    <h3>Agenda</h3>
    <div id="calendar"></div>
  </div>
</section>

<footer>¬© 2025 C√°ritas CNC. Todos los derechos reservados.</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

function showSection(id) {
  document.querySelectorAll("section").forEach((sec) => sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function showSubSection(id) {
  document.querySelectorAll(".subsection").forEach((sec) => sec.style.display = "none");
  document.getElementById(id).style.display = "block";
}

function goToListado() {
  if (auth.currentUser) {
    window.open("listado.html", "_blank");
  } else {
    window.location.href = "login.html";
  }
}

document.getElementById("familiaForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const msgDiv = document.getElementById("msg");
  msgDiv.innerHTML = "";
  const formData = new FormData(this);
  try {
    const res = await fetch("https://api-familias.onrender.com/familias", { method: "POST", body: formData });
    const data = await res.json();
    if (res.ok) {
      msgDiv.innerHTML = "<div class='success'>‚úÖ Registro exitoso</div>";
      this.reset();
    } else {
      msgDiv.innerHTML = `<div class='error'>‚ùå Error: ${data.error || "No se pudo registrar"}</div>`;
    }
  } catch {
    msgDiv.innerHTML = "<div class='error'>‚ùå No se pudo conectar</div>";
  }
});

function logout() {
  auth.signOut().then(() => showSection("inicio"));
}

document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");
  if (calendarEl) {
    const calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth' });
    calendar.render();
  }
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
