<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°ritas CNC ‚Äì Gesti√≥n</title>

  <!-- Estilos globales -->
  <link rel="stylesheet" href="styles.css?v=2" />

  <!-- PWA opcional -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b71c1c">

  <!-- Firebase (compat v10) y config (no re-inicializar aqu√≠). Cargar en diferido -->
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script defer src="firebase-config.js"></script>

  <!-- Supabase SDK v2 + config con url/anon key (diferido) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="supabase-config.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
</head>

<body>
  <header class="app-header" role="banner">
    <h1>C√°ritas CNC</h1>
    <nav aria-label="Navegaci√≥n principal">
      <button type="button" onclick="showSection('inicio')">Inicio</button>
      <button type="button" onclick="showSection('registro')">Registro</button>
      <button type="button" onclick="showSection('listado')">Listado</button>
      <button type="button" onclick="showSection('contacto')">Contacto</button>
      <button type="button" onclick="showSection('administracion')">Administraci√≥n</button>
      <button type="button" onclick="goLogin()" aria-label="Ir a iniciar sesi√≥n">Iniciar sesi√≥n</button>
      <button type="button" onclick="logout()" aria-label="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
    </nav>
  </header>

  <!-- INICIO -->
  <section id="inicio" class="seccion active" aria-labelledby="titulo-inicio">
    <h2 id="titulo-inicio">Bienvenido ‚ù§Ô∏è</h2>
    <p>Gracias por usar <b>C√°ritas CNC</b> para ayudar a las familias necesitadas. Desde aqu√≠ puedes registrar nuevas familias, consultar el listado existente y gestionar tareas internas del grupo.</p>
    <br>
    <button class="submit-btn" type="button" onclick="showSection('listado')">üìã Ver Listado de Familias</button>
  </section>

  <!-- REGISTRO -->
  <section id="registro" class="seccion" aria-labelledby="titulo-registro">
    <h2 id="titulo-registro">Registro de Familias</h2>
    <div id="msg" role="status" aria-live="polite"></div>
    <form id="familiaForm" enctype="multipart/form-data" novalidate>
      <label for="inpNombre">Nombres y Apellidos*</label>
      <input id="inpNombre" autocomplete="name" type="text" name="nombres_apellidos" required />

      <label for="inpDni">DNI*</label>
      <input id="inpDni" inputmode="numeric" autocomplete="off" type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />

      <label for="inpApellido">Apellido Familia*</label>
      <input id="inpApellido" type="text" name="apellido_familia" required />

      <label for="inpDireccion">Direcci√≥n*</label>
      <input id="inpDireccion" autocomplete="street-address" type="text" name="direccion" required />

      <label for="inpFecha">Fecha de Registro*</label>
      <input id="inpFecha" type="date" name="fecha_registro" required />

      <label for="inpTelefono">Tel√©fono*</label>
      <input id="inpTelefono" inputmode="tel" autocomplete="tel" type="text" name="telefono_contacto" pattern="[0-9]+" required />

      <label for="inpObs">Observaciones</label>
      <textarea id="inpObs" name="observaciones"></textarea>

      <label for="inpArchivo">Adjuntar documento</label>
      <input id="inpArchivo" type="file" name="archivo" accept=".pdf,.jpg,.png" />

      <label><input id="inpTyC" type="checkbox" required> Acepto los t√©rminos y condiciones</label>
      <button type="submit" class="submit-btn">Registrar</button>
    </form>
  </section>

  <!-- LISTADO (conecta a tu API si est√° disponible) -->
  <section id="listado" class="seccion" aria-labelledby="titulo-listado">
    <h2 id="titulo-listado">Listado de Familias</h2>
    <p id="familiasStatus" role="status" aria-live="polite">Con√©ctalo a tu API en Render o Supabase seg√∫n prefieras.</p>
    <table id="familiasTable">
      <thead>
        <tr>
          <th>Nombres</th><th>DNI</th><th>Apellido</th><th>Direcci√≥n</th>
          <th>Fecha</th><th>Tel√©fono</th><th>Observaciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="seccion" aria-labelledby="titulo-contacto">
    <h2 id="titulo-contacto">Contacto</h2>
    <p>Email: contacto@caritas.org</p>
    <p>Tel√©fono: +51 999 888 777</p>
  </section>

  <!-- ADMINISTRACI√ìN -->
  <section id="administracion" class="seccion" aria-labelledby="titulo-admin">
    <h2 id="titulo-admin">Administraci√≥n</h2>

    <div style="display:flex; gap:.5rem; margin:.5rem 0;">
      <button type="button" class="submit-btn" onclick="showSubSection('pendientes')">‚úÖ Pendientes de grupo</button>
      <button type="button" class="submit-btn" onclick="showSubSection('agendamiento')">üóìÔ∏è Agenda</button>
    </div>

    <!-- PENDIENTES EDITABLE -->
    <div id="pendientes" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Pendientes de grupo</h3>
      <p>Las tareas pendientes se almacenan en Supabase; puedes editarlas aqu√≠ y guardarlas.</p>

      <div style="display:flex; gap:.5rem; margin:.5rem 0;">
        <button class="submit-btn" type="button" onclick="addPendRow()">‚ûï A√±adir fila</button>
        <button class="submit-btn" type="button" onclick="savePendientes()">üíæ Guardar cambios</button>
        <span id="pendientesStatus" style="margin-left:.5rem;"></span>
      </div>

      <table id="pendientesTable">
        <thead>
          <tr>
            <th style="width:70%;">Descripci√≥n (editable)</th>
            <th style="width:15%;">Hecho</th>
            <th style="width:15%;">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pendientesError" style="color:#b00020; margin-top:.5rem;"></div>
    </div>

    <!-- AGENDAMIENTO / CALENDARIO -->
    <div id="agendamiento" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Agenda</h3>
      <div id="calendar" aria-label="Calendario de actividades"></div>
    </div>
  </section>

  <footer>¬© 2025 C√°ritas CNC. Todos los derechos reservados.</footer>

  <!-- ================== JS inline ================== -->
  <script>
  // Utilidad para escapar HTML de celdas contenteditable
  function escapeHTML(str){
    return (str||"")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Crear cliente Supabase con variables globales del config
  // Se espera que supabaseUrl y supabaseAnonKey est√©n definidos en supabase-config.js
  const supabaseClient = (typeof supabase !== 'undefined' && typeof supabaseUrl !== 'undefined')
    ? supabase.createClient(supabaseUrl, supabaseAnonKey)
    : null;

  // -------- Navegaci√≥n / secciones --------
  function showSection(id) {
    document.querySelectorAll('.seccion').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');

    // Acciones diferidas
    if (id === 'administracion') { showSubSection('pendientes'); }
    if (id === 'listado') { loadFamilias(); }
  }

  function showSubSection(id) {
    document.querySelectorAll('.subsection').forEach(s => s.style.display = 'none');
    const el = document.getElementById(id);
    if (el) el.style.display = 'block';

    // Cargas diferidas
    if (id === 'pendientes') loadPendientes();
    if (id === 'agendamiento') initCalendar();
  }

  function goLogin(){ window.location.href = 'login.html'; }

  function logout(){
    if (window.firebase && firebase.apps?.length) {
      firebase.auth().signOut().then(() => showSection('inicio'));
    }
  }

  // -------- Registro familias (POST a tu API) --------
  document.getElementById('familiaForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const msgDiv = document.getElementById('msg');
    msgDiv.innerHTML = '';
    const formData = new FormData(this);
    try {
      const res = await fetch('https://api-familias.onrender.com/familias', { method:'POST', body: formData });
      const data = await res.json().catch(()=>({}));
      if (res.ok) {
        msgDiv.innerHTML = "<div class='success'>‚úÖ Registro exitoso</div>";
        this.reset();
      } else {
        msgDiv.innerHTML = "<div class='error'>‚ùå Error al registrar</div>";
        console.error('API /familias:', data);
      }
    } catch(err){
      msgDiv.innerHTML = "<div class='error'>‚ùå No se pudo conectar</div>";
      console.error(err);
    }
  });

  // -------- Listado de familias (GET opcional) --------
  async function loadFamilias(){
    const tbody = document.querySelector('#familiasTable tbody');
    const status = document.getElementById('familiasStatus');
    if (!tbody) return;
    status.textContent = '‚è≥ Cargando...';
    try{
      const res = await fetch('https://api-familias.onrender.com/familias');
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      tbody.innerHTML = '';
      (data||[]).forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(f.nombres_apellidos)}</td>
          <td>${escapeHTML(f.dni_solicitante)}</td>
          <td>${escapeHTML(f.apellido_familia)}</td>
          <td>${escapeHTML(f.direccion)}</td>
          <td>${escapeHTML(f.fecha_registro)}</td>
          <td>${escapeHTML(f.telefono_contacto)}</td>
          <td>${escapeHTML(f.observaciones)}</td>`;
        tbody.appendChild(tr);
      });
      status.textContent = `‚úî ${data?.length||0} registros`;
    }catch(e){
      console.warn('Listado no disponible:', e.message);
      status.textContent = '‚ÑπÔ∏è El listado requiere que el endpoint GET /familias est√© disponible.';
    }
  }

  // -------- Pendientes (editable con UPSERT) --------
  function trPendiente({ id, descripcion = "", estado = false } = {}) {
    const tr = document.createElement('tr');
    if (id != null) tr.dataset.id = id;
    tr.innerHTML = `
      <td contenteditable="true">${escapeHTML(descripcion)}</td>
      <td style="text-align:center;"><input type="checkbox" ${estado ? 'checked' : ''} aria-label="Marcar como hecho"></td>
      <td style="text-align:center;"><button type="button" onclick="deletePendRow(this)" aria-label="Eliminar fila">üóëÔ∏è</button></td>
    `;
    return tr;
  }

  function addPendRow(){
    const tbody = document.querySelector('#pendientesTable tbody');
    if (tbody) tbody.appendChild(trPendiente({ descripcion:"", estado:false }));
  }

  function deletePendRow(btn){
    const tr = btn.closest('tr');
    if (tr) tr.remove();
  }

  async function loadPendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    if (!tbody || !supabaseClient) return;

    status.textContent = '‚è≥ Cargando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient
        .from('pendientes')
        .select('id, descripcion, estado')
        .order('id', { ascending: true });
      if (error) throw error;

      tbody.innerHTML = '';
      (data||[]).forEach(item => tbody.appendChild(trPendiente(item)));
      status.textContent = `‚úî ${data.length} tareas`;
    } catch(e){
      console.error('Error pendientes (load):', e);
      err.textContent = 'No se pudieron cargar los pendientes. Verifica la tabla y las credenciales.';
      status.textContent = '';
    }
  }

  async function savePendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    if (!tbody || !supabaseClient) return;

    const rows = [...tbody.querySelectorAll('tr')];
    const payload = rows.map(tr => {
      const [tdDesc, tdCheck] = tr.children;
      const id = tr.dataset.id ? Number(tr.dataset.id) : undefined;
      const descripcion = (tdDesc.textContent || '').trim();
      const estado = tdCheck.querySelector('input[type="checkbox"]').checked;
      const obj = { descripcion, estado };
      if (id) obj.id = id;
      return obj;
    });

    status.textContent = 'üíæ Guardando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient
        .from('pendientes')
        .upsert(payload, { onConflict: 'id' })
        .select('id, descripcion, estado');
      if (error) throw error;

      // refrescar con IDs consistentes
      const tbodyNew = document.createElement('tbody');
      (data||[]).sort((a,b)=>a.id-b.id).forEach(item => tbodyNew.appendChild(trPendiente(item)));
      tbody.replaceWith(tbodyNew);

      status.textContent = '‚úÖ Cambios guardados';
    } catch(e){
      console.error('Error pendientes (save):', e);
      err.textContent = 'No se pudieron guardar los cambios.';
      status.textContent = '';
    }
  }

  // ----- Calendario con persistencia en Supabase -----
  let calendar, calendarRendered = false;

  function supaToFc(ev){
    return { id: String(ev.id), title: ev.title, start: ev.start, end: ev.end || null };
  }

  async function fetchEventos(){
    if (!supabaseClient) return [];
    const { data, error } = await supabaseClient
      .from('eventos')
      .select('id, title, start, end')
      .order('start', { ascending: true });
    if (error) throw error;
    return (data||[]).map(supaToFc);
  }

  async function createEvento({ title, start, end }){
    const { data, error } = await supabaseClient
      .from('eventos')
      .insert([{ title, start, end }])
      .select('id, title, start, end')
      .single();
    if (error) throw error;
    return supaToFc(data);
  }

  async function updateEvento({ id, title, start, end }){
    const { data, error } = await supabaseClient
      .from('eventos')
      .update({ title, start, end })
      .eq('id', id)
      .select('id, title, start, end')
      .single();
    if (error) throw error;
    return supaToFc(data);
  }

  async function deleteEvento(id){
    const { error } = await supabaseClient.from('eventos').delete().eq('id', id);
    if (error) throw error;
  }

  async function initCalendar(){
    if (calendarRendered) return;
    const el = document.getElementById('calendar');
    if (!el || !window.FullCalendar) return;

    const initialEvents = await fetchEventos().catch(e => { console.error(e); return []; });

    calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      height: 'auto',
      selectable: true,
      editable: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: initialEvents,

      dateClick: async (info) => {
        const title = prompt('T√≠tulo del evento:');
        if (!title) return;
        try {
          const saved = await createEvento({ title, start: info.dateStr, end: null });
          calendar.addEvent(saved);
        } catch (e) { console.error(e); alert('No se pudo crear el evento'); }
      },

      eventDrop: async ({ event }) => {
        try {
          await updateEvento({
            id: Number(event.id),
            title: event.title,
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : null
          });
        } catch (e) { console.error(e); alert('No se pudo actualizar el evento'); event.revert(); }
      },
      eventResize: async ({ event }) => {
        try {
          await updateEvento({
            id: Number(event.id),
            title: event.title,
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : null
          });
        } catch (e) { console.error(e); alert('No se pudo actualizar el evento'); event.revert(); }
      },

      eventClick: async ({ event }) => {
        if (!confirm(`Eliminar evento: "${event.title}"?`)) return;
        try {
          await deleteEvento(Number(event.id));
          event.remove();
        } catch (e) { console.error(e); alert('No se pudo eliminar el evento'); }
      }
    });

    calendar.render();
    calendarRendered = true;
  }

  // -------- Inicio --------
  document.addEventListener('DOMContentLoaded', () => {
    // Si usas PWA:
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js", { updateViaCache: "none" })
        .then(reg => reg.update().catch(()=>{}))
        .catch(()=>{});
    }
  });
  </script>
</body>
</html>