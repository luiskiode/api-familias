<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>C√°ritas CNC ‚Äì Gesti√≥n de Familias</title>
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#b71c1c" />
    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css" />
    <!-- FullCalendar (solo se usar√° si se inicializa) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>C√°ritas CNC</h1>
      <nav class="app-nav">
        <button onclick="showSection('inicio')">Inicio</button>
        <button onclick="showSection('registro')">Registro</button>
        <button onclick="showSection('contacto')">Contacto</button>
        <button onclick="showSection('administracion')">Administraci√≥n</button>
        <!-- Botones de inicio/cierre de sesi√≥n -->
        <button id="loginBtn" onclick="showLogin()">Iniciar sesi√≥n</button>
        <button id="logoutBtn" onclick="logout()" style="display:none;">Cerrar sesi√≥n</button>
      </nav>
    </header>

    <main>
      <!-- Secci√≥n de bienvenida -->
      <section id="inicio" class="seccion active">
        <h2>Bienvenido ‚ù§Ô∏è</h2>
        <p>
          Gracias por usar <b>C√°ritas CNC</b> para ayudar a las familias
          necesitadas. Desde aqu√≠ puedes registrar nuevas familias,
          consultar el listado existente y gestionar tareas internas del
          grupo.
        </p>
      </section>

      <!-- Secci√≥n de registro de familias -->
      <section id="registro" class="seccion">
        <h2>Registro de Familias</h2>
        <div id="msg"></div>
        <form id="familiaForm" enctype="multipart/form-data">
          <label>Nombres y Apellidos*</label>
          <input type="text" name="nombres_apellidos" required />
          <label>DNI*</label>
          <input
            type="text"
            name="dni_solicitante"
            maxlength="8"
            pattern="[0-9]{8}"
            required
          />
          <label>Apellido Familia*</label>
          <input type="text" name="apellido_familia" required />
          <label>Direcci√≥n*</label>
          <input type="text" name="direccion" required />
          <label>Fecha de Registro*</label>
          <input type="date" name="fecha_registro" required />
          <label>Tel√©fono*</label>
          <input type="text" name="telefono_contacto" pattern="[0-9]+" required />
          <label>Observaciones</label>
          <textarea name="observaciones"></textarea>
          <label>Adjuntar documento</label>
          <input type="file" name="archivo" accept=".pdf,.jpg,.png" />
          <label>
            <input type="checkbox" required /> Acepto los t√©rminos y
            condiciones
          </label>
          <button type="submit" class="submit-btn">Registrar</button>
        </form>
      </section>

      <!-- Secci√≥n del listado de familias -->
      <section id="listado" class="seccion">
        <h2>Listado de Familias</h2>
        <input type="text" id="search" placeholder="Buscar familia..." />
        <table id="familiasTable">
          <thead>
            <tr>
              <th>Nombres</th>
              <th>DNI</th>
              <th>Apellido</th>
              <th>Direcci√≥n</th>
              <th>Fecha</th>
              <th>Tel√©fono</th>
              <th>Observaciones</th>
              <th>Documento</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Secci√≥n de contacto -->
      <section id="contacto" class="seccion">
        <h2>Contacto</h2>
        <p>Email: contacto@caritas.org</p>
        <p>Tel√©fono: +51 999 888 777</p>
      </section>

      <!-- Secci√≥n de administraci√≥n -->
      <section id="administracion" class="seccion">
        <h2>Administraci√≥n</h2>
        <!-- Sub-secciones -->
        <button onclick="showSubSection('pendientes')">‚úÖ Pendientes de grupo</button>
        <button onclick="showSubSection('agendamiento')">üìÖ Agenda</button>

        <!-- Pendientes de grupo -->
        <div id="pendientes" class="subsection" style="display:none; margin-top:1rem;">
          <h3>Pendientes de grupo</h3>
          <ul id="pendientesList"></ul>
          <p style="font-size:0.9rem; color:#777;">
            Las tareas pendientes se almacenan en la base de datos y puedes
            marcarlas como completadas con el check.
          </p>
        </div>

        <!-- Agendamiento (calendario) -->
        <div id="agendamiento" class="subsection" style="display:none; margin-top:1rem;">
          <h3>Agenda</h3>
          <div id="calendar"></div>
        </div>

        <!-- Inventario de v√≠veres -->
        <div id="inventario" class="subsection" style="margin-top:1rem;">
          <h3>Inventario de v√≠veres</h3>
          <iframe
            id="inventoryFrame"
            title="Inventario de v√≠veres"
            width="100%"
            height="420"
            frameborder="0"
            src=""
          ></iframe>
          <p style="font-size:0.8rem; color:#555; margin-top:0.5rem;">
            Para vincular tu inventario, publica tu hoja de c√°lculo en l√≠nea (Google
            Sheets o Excel Online) y pega aqu√≠ el enlace de inserci√≥n en el atributo
            <code>src</code> del iframe. Puedes hacerlo modificando la variable
            <code>inventoryURL</code> en el script.
          </p>
        </div>
      </section>
    </main>

    <footer>
      ¬© <span id="year"></span> C√°ritas CNC. Todos los derechos reservados.
    </footer>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Configuraci√≥n de Firebase (debes definir tu firebaseConfig y auth en este archivo) -->
    <script src="firebase-config.js"></script>

    <!-- Supabase (para familias y tareas) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <!-- Script principal -->
    <script>
      // Variables de Supabase
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

      // URL del inventario (reemplaza por el enlace embed de tu hoja de c√°lculo)
      const inventoryURL = "";

      // Actualiza el a√±o en el footer
      function updateYear() {
        document.getElementById("year").textContent = new Date().getFullYear();
      }

      // Mostrar/ocultar secciones principales
      function showSection(id) {
        document.querySelectorAll("main > section").forEach((sec) => {
          sec.classList.remove("active");
        });
        document.getElementById(id).classList.add("active");
      }

      // Mostrar sub-secciones dentro de administraci√≥n
      function showSubSection(id) {
        document.querySelectorAll(".subsection").forEach((sec) => {
          sec.style.display = "none";
        });
        const element = document.getElementById(id);
        if (element) element.style.display = "block";
      }

      // Redirige a la p√°gina de inicio de sesi√≥n
      function showLogin() {
        window.location.href = "login.html";
      }

      // Cierre de sesi√≥n
      function logout() {
        auth.signOut().then(() => {
          document.getElementById("loginBtn").style.display = "inline-block";
          document.getElementById("logoutBtn").style.display = "none";
          // Ocultar secciones protegidas
          document.getElementById("listado").style.display = "none";
          document.getElementById("administracion").style.display = "none";
          showSection("inicio");
        });
      }

      // Cargar familias desde la API
      async function loadFamilias() {
        try {
          const { data, error } = await supabaseClient
            .from("familias")
            .select("*")
            .order("id", { ascending: false });
          if (error) throw error;
          const tbody = document.querySelector("#familiasTable tbody");
          tbody.innerHTML = "";
          data.forEach((fam) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${fam.nombres_apellidos || ""}</td>
              <td>${fam.dni_solicitante || ""}</td>
              <td>${fam.apellido_familia || ""}</td>
              <td>${fam.direccion || ""}</td>
              <td>${fam.fecha_registro || ""}</td>
              <td>${fam.telefono_contacto || ""}</td>
              <td>${fam.observaciones || ""}</td>
              <td>
                ${fam.archivo_url ? `<a href="${fam.archivo_url}" target="_blank">üìÑ</a>` : ""}
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Error al cargar familias:", err);
        }
      }

      // Enviar nueva familia al backend
      document.getElementById("familiaForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const msgDiv = document.getElementById("msg");
        msgDiv.textContent = "";
        const formData = new FormData(this);
        try {
          // Usa fetch para enviar al backend, ajusta la URL si cambias tu backend
          const res = await fetch("https://api-familias.onrender.com/familias", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (res.ok) {
            msgDiv.innerHTML = "<div class='success'>‚úÖ Registro exitoso</div>";
            this.reset();
            loadFamilias();
          } else {
            msgDiv.innerHTML = `<div class='error'>‚ùå Error: ${data.error || "No se pudo registrar"}</div>`;
          }
        } catch (err) {
          msgDiv.innerHTML = "<div class='error'>‚ùå No se pudo conectar</div>";
        }
      });

      // Cargar pendientes desde Supabase
      async function loadPendientes() {
        try {
          const { data, error } = await supabaseClient
            .from("pendientes")
            .select("id, descripcion, estado")
            .order("id", { ascending: true });
          if (error) throw error;
          const ul = document.getElementById("pendientesList");
          ul.innerHTML = "";
          data.forEach((task) => {
            const li = document.createElement("li");
            li.innerHTML = `
              <input type="checkbox" ${task.estado ? "checked" : ""} onchange="togglePendiente(${task.id}, this.checked)" />
              <span>${task.descripcion}</span>
            `;
            ul.appendChild(li);
          });
        } catch (err) {
          console.error("Error al cargar pendientes:", err);
        }
      }

      // Marcar o desmarcar pendiente
      async function togglePendiente(id, done) {
        try {
          const { error } = await supabaseClient
            .from("pendientes")
            .update({ estado: done })
            .eq("id", id);
          if (error) throw error;
          // Recarga la lista de pendientes
          loadPendientes();
        } catch (err) {
          console.error("Error al actualizar pendiente:", err);
        }
      }

      // Inicializar FullCalendar
      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        if (calendarEl && window.FullCalendar) {
          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            locale: "es",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek,timeGridDay",
            },
            events: [],
          });
          calendar.render();
        }
      }

      // Escuchar cambios de autenticaci√≥n
      auth.onAuthStateChanged((user) => {
        if (user) {
          // Usuario autenticado
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("logoutBtn").style.display = "inline-block";
          // Mostrar secciones protegidas
          document.getElementById("listado").style.display = "block";
          document.getElementById("administracion").style.display = "block";
          // Cargar datos
          loadFamilias();
          loadPendientes();
        } else {
          // Usuario no autenticado
          document.getElementById("loginBtn").style.display = "inline-block";
          document.getElementById("logoutBtn").style.display = "none";
          document.getElementById("listado").style.display = "none";
          document.getElementById("administracion").style.display = "none";
          showSection("inicio");
        }
      });

      // Inicializar app una vez cargado el DOM
      document.addEventListener("DOMContentLoaded", () => {
        updateYear();
        initCalendar();
        // Asigna la URL del inventario
        if (inventoryURL) {
          document.getElementById("inventoryFrame").src = inventoryURL;
        }
      });
    </script>
  </body>
</html>