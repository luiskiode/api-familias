<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cáritas CNC – Gestión</title>

  <!-- Estilos globales -->
  <link rel="stylesheet" href="styles.css?v=1" />

  <!-- PWA opcional -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b71c1c">

  <!-- Firebase (compat) y config (NO volver a inicializar aquí) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Supabase SDK (para crear cliente) + config con url/anon key -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
</head>

<body>
  <header class="app-header">
    <h1>Cáritas CNC</h1>
    <nav>
      <button type="button" onclick="showSection('inicio')">Inicio</button>
      <button type="button" onclick="showSection('registro')">Registro</button>
      <button type="button" onclick="showSection('contacto')">Contacto</button>
      <button type="button" onclick="showSection('administracion')">Administración</button>
      <button type="button" onclick="goLogin()">Iniciar sesión</button>
      <button type="button" onclick="logout()">Cerrar sesión</button>
    </nav>
  </header>

  <!-- INICIO -->
  <section id="inicio" class="seccion active">
    <h2>Bienvenido ❤️</h2>
    <p>Gracias por usar <b>Cáritas CNC</b> para ayudar a las familias necesitadas. Desde aquí puedes registrar nuevas familias, consultar el listado existente y gestionar tareas internas del grupo.</p>
    <br>
    <button class="submit-btn" type="button" onclick="showSection('listado')">📋 Ver Listado de Familias</button>
  </section>

  <!-- REGISTRO -->
  <section id="registro" class="seccion">
    <h2>Registro de Familias</h2>
    <div id="msg"></div>
    <form id="familiaForm" enctype="multipart/form-data">
      <label>Nombres y Apellidos*</label>
      <input type="text" name="nombres_apellidos" required />
      <label>DNI*</label>
      <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />
      <label>Apellido Familia*</label>
      <input type="text" name="apellido_familia" required />
      <label>Dirección*</label>
      <input type="text" name="direccion" required />
      <label>Fecha de Registro*</label>
      <input type="date" name="fecha_registro" required />
      <label>Teléfono*</label>
      <input type="text" name="telefono_contacto" pattern="[0-9]+" required />
      <label>Observaciones</label>
      <textarea name="observaciones"></textarea>
      <label>Adjuntar documento</label>
      <input type="file" name="archivo" accept=".pdf,.jpg,.png" />
      <label><input type="checkbox" required> Acepto los términos y condiciones</label>
      <button type="submit" class="submit-btn">Registrar</button>
    </form>
  </section>

  <!-- LISTADO (placeholder; conecta a tu API si quieres) -->
  <section id="listado" class="seccion">
    <h2>Listado de Familias</h2>
    <p>Conéctalo a tu API en Render o Supabase según prefieras.</p>
    <table id="familiasTable">
      <thead>
        <tr>
          <th>Nombres</th><th>DNI</th><th>Apellido</th><th>Dirección</th>
          <th>Fecha</th><th>Teléfono</th><th>Observaciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="seccion">
    <h2>Contacto</h2>
    <p>Email: contacto@caritas.org</p>
    <p>Teléfono: +51 999 888 777</p>
  </section>

  <!-- ADMINISTRACIÓN -->
  <section id="administracion" class="seccion">
    <h2>Administración</h2>

    <div style="display:flex; gap:.5rem; margin:.5rem 0;">
      <button type="button" class="submit-btn" onclick="showSubSection('pendientes')">✅ Pendientes de grupo</button>
      <button type="button" class="submit-btn" onclick="showSubSection('agendamiento')">🗓️ Agenda</button>
    </div>

    <!-- PENDIENTES EDITABLE -->
    <div id="pendientes" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Pendientes de grupo</h3>
      <p>Las tareas pendientes se almacenan en Supabase; puedes editarlas aquí y guardarlas.</p>

      <div style="display:flex; gap:.5rem; margin:.5rem 0;">
        <button class="submit-btn" type="button" onclick="addPendRow()">➕ Añadir fila</button>
        <button class="submit-btn" type="button" onclick="savePendientes()">💾 Guardar cambios</button>
        <span id="pendientesStatus" style="margin-left:.5rem;"></span>
      </div>

      <table id="pendientesTable">
        <thead>
          <tr>
            <th style="width:70%;">Descripción (editable)</th>
            <th style="width:15%;">Hecho</th>
            <th style="width:15%;">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pendientesError" style="color:#b00020; margin-top:.5rem;"></div>
    </div>

    <script>
  // ----- Calendario con persistencia en Supabase -----
  let calendar, calendarRendered = false;

  function supaToFc(ev){
    return { id: String(ev.id), title: ev.title, start: ev.start, end: ev.end || null };
  }

  async function fetchEventos(){
    const { data, error } = await supabaseClient
      .from('eventos')
      .select('id, title, start, end')
      .order('start', { ascending: true });
    if (error) throw error;
    return data.map(supaToFc);
  }

  async function createEvento({ title, start, end }){
    const { data, error } = await supabaseClient
      .from('eventos')
      .insert([{ title, start, end }])
      .select('id, title, start, end')
      .single();
    if (error) throw error;
    return supaToFc(data);
  }

  async function updateEvento({ id, title, start, end }){
    const { data, error } = await supabaseClient
      .from('eventos')
      .update({ title, start, end })
      .eq('id', id)
      .select('id, title, start, end')
      .single();
    if (error) throw error;
    return supaToFc(data);
  }

  async function deleteEvento(id){
    const { error } = await supabaseClient.from('eventos').delete().eq('id', id);
    if (error) throw error;
  }

  async function initCalendar(){
    const el = document.getElementById('calendar');
    if (!el || !window.FullCalendar || calendarRendered) return;

    const initialEvents = await fetchEventos().catch(e => { console.error(e); return []; });

    calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      height: 'auto',
      selectable: true,
      editable: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: initialEvents,

      // Crear evento con click en día
      dateClick: async (info) => {
        const title = prompt('Título del evento:');
        if (!title) return;
        try {
          const saved = await createEvento({ title, start: info.dateStr, end: null });
          calendar.addEvent(saved);
        } catch (e) { console.error(e); alert('No se pudo crear el evento'); }
      },

      // Editar arrastrando o redimensionando
      eventDrop: async ({ event }) => {
        try {
          await updateEvento({
            id: Number(event.id),
            title: event.title,
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : null
          });
        } catch (e) { console.error(e); alert('No se pudo actualizar el evento'); event.revert(); }
      },
      eventResize: async ({ event }) => {
        try {
          await updateEvento({
            id: Number(event.id),
            title: event.title,
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : null
          });
        } catch (e) { console.error(e); alert('No se pudo actualizar el evento'); event.revert(); }
      },

      // Borrar con click
      eventClick: async ({ event }) => {
        if (!confirm(`Eliminar evento: "${event.title}"?`)) return;
        try {
          await deleteEvento(Number(event.id));
          event.remove();
        } catch (e) { console.error(e); alert('No se pudo eliminar el evento'); }
      }
    });

    calendar.render();
    calendarRendered = true;
  }
</script>


  <footer>© 2025 Cáritas CNC. Todos los derechos reservados.</footer>

  <!-- ================== JS inline ================== -->
  <script>
  // Crear cliente Supabase con variables globales del config
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  // -------- Navegación / secciones --------
  function showSection(id) {
    document.querySelectorAll('.seccion').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');

    // Si abrimos administración, por defecto mostrar 'pendientes'
    if (id === 'administracion') {
      showSubSection('pendientes');
    }
  }

  function showSubSection(id) {
    document.querySelectorAll('.subsection').forEach(s => s.style.display = 'none');
    const el = document.getElementById(id);
    if (el) el.style.display = 'block';

    // Cargas diferidas
    if (id === 'pendientes') loadPendientes();
    if (id === 'agendamiento') initCalendar();
  }

  function goLogin(){ window.location.href = 'login.html'; }

  function logout(){
    auth.signOut().then(() => showSection('inicio'));
  }

  // -------- Registro familias (placeholder a tu API) --------
  document.getElementById('familiaForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const msgDiv = document.getElementById('msg');
    msgDiv.innerHTML = '';
    const formData = new FormData(this);
    try {
      const res = await fetch('https://api-familias.onrender.com/familias', { method:'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        msgDiv.innerHTML = "<div class='success'>✅ Registro exitoso</div>";
        this.reset();
      } else {
        msgDiv.innerHTML = "<div class='error'>❌ Error al registrar</div>";
        console.error('API /familias:', data);
      }
    } catch(err){
      msgDiv.innerHTML = "<div class='error'>❌ No se pudo conectar</div>";
      console.error(err);
    }
  });

  // -------- Pendientes (editable con UPSERT) --------
  function trPendiente({ id, descripcion = "", estado = false } = {}) {
    const tr = document.createElement('tr');
    if (id != null) tr.dataset.id = id;
    tr.innerHTML = `
      <td contenteditable="true">${(descripcion ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[m]))}</td>
      <td style="text-align:center;"><input type="checkbox" ${estado ? 'checked' : ''}></td>
      <td style="text-align:center;"><button type="button" onclick="deletePendRow(this)">🗑️</button></td>
    `;
    return tr;
  }

  function addPendRow(){
    const tbody = document.querySelector('#pendientesTable tbody');
    if (tbody) tbody.appendChild(trPendiente({ descripcion:"", estado:false }));
  }

  function deletePendRow(btn){
    const tr = btn.closest('tr');
    if (tr) tr.remove();
  }

  async function loadPendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    if (!tbody) return;

    status.textContent = '⏳ Cargando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient
        .from('pendientes')
        .select('id, descripcion, estado')
        .order('id', { ascending: true });
      if (error) throw error;

      tbody.innerHTML = '';
      data.forEach(item => tbody.appendChild(trPendiente(item)));
      status.textContent = `✔ ${data.length} tareas`;
    } catch(e){
      console.error('Error pendientes (load):', e);
      err.textContent = 'No se pudieron cargar los pendientes.';
      status.textContent = '';
    }
  }

  async function savePendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    if (!tbody) return;

    const rows = [...tbody.querySelectorAll('tr')];
    const payload = rows.map(tr => {
      const [tdDesc, tdCheck] = tr.children;
      const id = tr.dataset.id ? Number(tr.dataset.id) : undefined;
      const descripcion = (tdDesc.textContent || '').trim();
      const estado = tdCheck.querySelector('input[type="checkbox"]').checked;
      const obj = { descripcion, estado };
      if (id) obj.id = id;
      return obj;
    });

    status.textContent = '💾 Guardando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient
        .from('pendientes')
        .upsert(payload, { onConflict: 'id' })
        .select('id, descripcion, estado');
      if (error) throw error;

      // refrescar con IDs consistentes
      const tbodyNew = document.createElement('tbody');
      data.sort((a,b)=>a.id-b.id).forEach(item => tbodyNew.appendChild(trPendiente(item)));
      tbody.replaceWith(tbodyNew);

      status.textContent = '✅ Cambios guardados';
    } catch(e){
      console.error('Error pendientes (save):', e);
      err.textContent = 'No se pudieron guardar los cambios.';
      status.textContent = '';
    }
  }

  // -------- Calendario --------
  let calendarRendered = false;
  function initCalendar(){
    const el = document.getElementById('calendar');
    if (!el || !window.FullCalendar || calendarRendered) return;
    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: [
        { title: 'Reunión de jóvenes', start: new Date().toISOString().slice(0,10) }
      ]
    });
    calendar.render();
    calendarRendered = true;
  }

  // -------- Inicio --------
  document.addEventListener('DOMContentLoaded', () => {
    // Si usas PWA:
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js", { updateViaCache: "none" })
        .then(reg => reg.update().catch(()=>{}))
        .catch(()=>{});
    }
  });
  </script>
</body>
</html>

