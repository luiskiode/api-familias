<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°ritas CNC ‚Äì Gesti√≥n</title>

  <!-- Estilos globales -->
  <link rel="stylesheet" href="styles.css?v=4" />

  <!-- PWA opcional -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#b71c1c" />

  <!-- Firebase (compat) y config -->
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script defer src="firebase-config.js"></script>

  <!-- Supabase SDK -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script defer src="supabase-config.js"></script>

  <!-- FullCalendar CSS (CDN fiable) -->
  <link href="https://unpkg.com/@fullcalendar/core@6.1.8/index.global.css" rel="stylesheet" />
  <link href="https://unpkg.com/@fullcalendar/daygrid@6.1.8/index.global.css" rel="stylesheet" />

  <!-- FullCalendar JS (LOCAL) -->
  

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

<!-- FullCalendar CSS (CDN confiable) -->
<link href="https://unpkg.com/@fullcalendar/core@6.1.8/index.global.css" rel="stylesheet" />
<link href="https://unpkg.com/@fullcalendar/daygrid@6.1.8/index.global.css" rel="stylesheet" />

<!-- FullCalendar JS (CDN confiable) -->
<script defer src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>


<!-- FullCalendar CSS (CDN confiable) -->
<link href="https://unpkg.com/@fullcalendar/core@6.1.8/index.global.min.css" rel="stylesheet" />
<link href="https://unpkg.com/@fullcalendar/daygrid@6.1.8/index.global.min.css" rel="stylesheet" />

<!-- FullCalendar JS (CDN confiable) -->
<script src="https://unpkg.com/@fullcalendar/core@6.1.8/index.global.min.js"></script>
<script src="https://unpkg.com/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>

</head>

<body>
  <header class="app-header">
    <h1>C√°ritas CNC</h1>
    <nav>
      <button type="button" onclick="showSection('inicio')">Inicio</button>
      <button type="button" onclick="showSection('registro')">Registro</button>
      <button type="button" onclick="showSection('contacto')">Contacto</button>
      <button type="button" onclick="showSection('administracion')">Administraci√≥n</button>
      <button type="button" id="btn-login" onclick="goLogin()">Iniciar sesi√≥n</button>
      <button type="button" id="btn-logout" style="display:none;" onclick="logout()">Cerrar sesi√≥n</button>
    </nav>
  </header>

  <!-- INICIO -->
  <section id="inicio" class="seccion active">
    <h2>Bienvenido ‚ù§Ô∏è</h2>
    <p>Gracias por usar <b>C√°ritas CNC</b>. Desde aqu√≠ puedes registrar nuevas familias y gestionar tareas internas del grupo.</p>
  </section>

  <!-- REGISTRO -->
  <section id="registro" class="seccion">
    <h2>Registro de Familias</h2>
    <div id="msg"></div>

    <form id="familiaForm" enctype="multipart/form-data">
      <label>Nombres y Apellidos*</label>
      <input type="text" name="nombres_apellidos" required />

      <label>DNI*</label>
      <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />

      <label>Apellido Familia*</label>
      <input type="text" name="apellido_familia" required />

      <label>Direcci√≥n* (con sugerencias)</label>
      <div class="row">
        <input type="text" id="reg-direccion" name="direccion" list="dl-direcciones" autocomplete="off" required />
        <button type="button" class="submit-btn" id="btn-ver-mapa">üìç Ver en mapa</button>
      </div>
      <datalist id="dl-direcciones"></datalist>

      <label>Fecha de Registro*</label>
      <input type="date" name="fecha_registro" required />

      <label>Tel√©fono*</label>
      <input type="text" name="telefono_contacto" pattern="[0-9]+" required />

      <label>Observaciones</label>
      <textarea name="observaciones"></textarea>

      <label>Adjuntar documento</label>
      <input type="file" name="archivo" accept=".pdf,.jpg,.png" />

      <label><input type="checkbox" required> Acepto los t√©rminos y condiciones</label>
      <button type="submit" class="submit-btn">Registrar</button>
    </form>

    <div style="margin-top:12px">
      <div id="map" style="height:320px;border-radius:14px;border:1px solid #e6e6e6;background:#f6f7f9"></div>
    </div>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="seccion">
    <h2>Contacto</h2>
    <p>Email: contacto@caritas.org</p>
    <p>Tel√©fono: +51 999 888 777</p>
  </section>

  <!-- ADMINISTRACI√ìN -->
  <section id="administracion" class="seccion">
    <h2>Administraci√≥n</h2>

    <div style="display:flex; gap:.5rem; margin:.5rem 0; flex-wrap:wrap;">
      <button type="button" class="submit-btn" onclick="showSubSection('pendientes')">‚úÖ Pendientes de grupo</button>
      <button type="button" class="submit-btn" onclick="showSubSection('agendamiento')">üóìÔ∏è Agenda</button>
      <button type="button" id="btn-admin-familias" class="submit-btn hidden" onclick="showSubSection('familiasAdmin')">üë™ Familias registradas</button>
    </div>

    <!-- PENDIENTES -->
    <div id="pendientes" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Pendientes de grupo</h3>
      <p>Las tareas pendientes se almacenan en Supabase; puedes editarlas aqu√≠ y guardarlas.</p>

      <div style="display:flex; gap:.5rem; margin:.5rem 0;">
        <button class="submit-btn" type="button" onclick="addPendRow()">‚ûï A√±adir fila</button>
        <button class="submit-btn" type="button" onclick="savePendientes()">üíæ Guardar cambios</button>
        <span id="pendientesStatus" style="margin-left:.5rem;"></span>
      </div>

      <table id="pendientesTable">
        <thead>
          <tr>
            <th style="width:70%;">Descripci√≥n (editable)</th>
            <th style="width:15%;">Hecho</th>
            <th style="width:15%;">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pendientesError" style="color:#b00020; margin-top:.5rem;"></div>
    </div>

    <!-- CALENDARIO -->
    <div id="agendamiento" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Agenda</h3>
      <div id="calendar"></div>

      <!-- Modal Evento (CRUD) -->
      <div id="event-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:50; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#1b1b1b; width:min(520px,92vw); border-radius:14px; border:1px solid #e7e7e7; box-shadow:0 18px 40px rgba(0,0,0,.25);">
          <div style="padding:14px 16px; border-bottom:1px solid #eee; font-weight:700">Evento</div>
          <form id="event-form" style="padding:14px 16px; display:grid; gap:10px">
            <input type="hidden" id="ev-id" />
            <label>T√≠tulo
              <input id="ev-title" required />
            </label>
            <label>Inicio
              <input id="ev-start" type="datetime-local" required />
            </label>
            <label>Fin (opcional)
              <input id="ev-end" type="datetime-local" />
            </label>
            <label style="display:flex; gap:.5rem; align-items:center;">
              <input id="ev-allday" type="checkbox" />
              Todo el d√≠a
            </label>

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px">
              <button type="button" id="ev-delete" class="submit-btn" style="background:#fff; color:#1b1b1b; border:1px solid #e0e0e0">üóëÔ∏è Borrar</button>
              <button type="button" id="ev-cancel" class="submit-btn" style="background:#fff; color:#1b1b1b; border:1px solid #e0e0e0">Cancelar</button>
              <button type="submit" class="submit-btn">Guardar</button>
            </div>
          </form>
        </div>
      </div>
      <!-- /Modal -->
    </div>

    <!-- FAMILIAS (SOLO LOGUEADO) -->
    <div id="familiasAdmin" class="subsection" style="display:none; margin-top:1rem;">
      <h3>Familias registradas</h3>
      <p class="muted" id="familiasNotice" style="display:none;">Debes iniciar sesi√≥n para ver esta informaci√≥n.</p>

      <div class="row" style="margin:.5rem 0;">
        <input id="fam-search" placeholder="üîé Buscar por nombres, apellido, direcci√≥n o DNI‚Ä¶" />
        <button type="button" class="submit-btn" id="fam-refresh">‚Üª Actualizar</button>
        <span class="muted" id="fam-count"></span>
      </div>

      <table id="familiasAdminTable">
        <thead>
          <tr>
            <th>Nombres</th><th>DNI</th><th>Apellido</th><th>Direcci√≥n</th>
            <th>Fecha</th><th>Tel√©fono</th><th>Observaciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="familiasAdminError" class="error" style="display:none;margin-top:.5rem;">No se pudo cargar el listado.</div>
    </div>
  </section>

  <footer>¬© 2025 C√°ritas CNC. Todos los derechos reservados.</footer>

  <!-- ================== JS ================== -->
  <script>
  var calendarInstance = null;
let calendarInstance = null;
// --- Supabase client
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  // --- Navegaci√≥n
  function showSection(id) {
    document.querySelectorAll('.seccion').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
    if (id === 'administracion') showSubSection('pendientes');
  }

  function showSubSection(id) {
    document.querySelectorAll('.subsection').forEach(s => s.style.display = 'none');
    const el = document.getElementById(id);
    if (!el) return;

    // Gate de autenticaci√≥n para Familias
    if (id === 'familiasAdmin') {
      const user = (window.firebase && firebase.auth) ? firebase.auth().currentUser : null;
      const notice = document.getElementById('familiasNotice');
      if (!user) {
        notice.style.display = 'block';
        el.style.display = 'block';
        const tbody = document.querySelector('#familiasAdminTable tbody');
        if (tbody) tbody.innerHTML = '';
        document.getElementById('fam-count').textContent = '';
        return;
      } else {
        notice.style.display = 'none';
        el.style.display = 'block';
        loadFamiliasAdmin();
        return;
      }
    }

    // Mostrar primero, luego inicializar dependientes de visibilidad
    el.style.display = 'block';
    if (id === 'pendientes') loadPendientes();
    if (id === 'agendamiento') initCalendar();
  }

  function goLogin(){ window.location.href = 'login.html'; }
  function logout(){
    const fbAuth = (typeof auth !== 'undefined' && auth) ? auth : (firebase.auth ? firebase.auth() : null);
    if (fbAuth) {
      fbAuth.signOut().then(() => { updateAuthUI(null); showSection('inicio'); });
    }
  }

  function updateAuthUI(user) {
    document.getElementById('btn-login').style.display = user ? 'none' : 'inline-block';
    document.getElementById('btn-logout').style.display = user ? 'inline-block' : 'none';
    const btnFam = document.getElementById('btn-admin-familias');
    if (btnFam) btnFam.classList.toggle('hidden', !user);
    if (!user && document.getElementById('familiasAdmin').style.display === 'block') {
      const tbody = document.querySelector('#familiasAdminTable tbody');
      if (tbody) tbody.innerHTML = '';
      document.getElementById('fam-count').textContent = '';
      document.getElementById('familiasNotice').style.display = 'block';
    }
  }

  // --- Registro (API Render absoluta)
  document.getElementById('familiaForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const msgDiv = document.getElementById('msg');
    msgDiv.innerHTML = '';
    const formData = new FormData(this);
    try {
      const res = await fetch('https://api-familias.onrender.com/familias', { method:'POST', body: formData });
      const data = await res.json();
      if (res.ok) { msgDiv.innerHTML = "<div class='success'>‚úÖ Registro exitoso</div>"; this.reset(); }
      else { msgDiv.innerHTML = "<div class='error'>‚ùå Error al registrar</div>"; console.error(data); }
    } catch(err){
      msgDiv.innerHTML = "<div class='error'>‚ùå No se pudo conectar</div>";
    }
  });

  // --- Leaflet + Nominatim
  let map, marker;
  function initMap() {
    map = L.map('map', { center: [-12.0464, -77.0428], zoom: 12 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  }
  function centerMap(lat, lng, label='') {
    const pos = [lat, lng];
    map.setView(pos, 16);
    if (!marker) marker = L.marker(pos).addTo(map);
    else marker.setLatLng(pos);
    if (label) marker.bindPopup(label).openPopup();
  }
  async function geocodeAddress(q, limit=1){
    const u = new URL('https://nominatim.openstreetmap.org/search');
    u.searchParams.set('format','json'); u.searchParams.set('q', q);
    u.searchParams.set('addressdetails','1'); u.searchParams.set('limit', String(limit));
    const r = await fetch(u, { headers: { 'Accept-Language':'es' } });
    if (!r.ok) throw new Error('Nominatim error');
    return r.json();
  }
  const dirInput = document.getElementById('reg-direccion');
  const dl = document.getElementById('dl-direcciones');
  let sugTimer;
  dirInput.addEventListener('input', () => {
    clearTimeout(sugTimer);
    const q = dirInput.value.trim();
    if (q.length < 3) { dl.innerHTML = ''; return; }
    sugTimer = setTimeout(async () => {
      try {
        const results = await geocodeAddress(q, 5);
        dl.innerHTML = results.map(r => `<option value="${escapeHtml(r.display_name)}"></option>`).join('');
      } catch {}
    }, 350);
  });
  document.getElementById('btn-ver-mapa').addEventListener('click', async () => {
    const q = dirInput.value.trim(); if (!q) return;
    try {
      const [r] = await geocodeAddress(q, 1) || [];
      if (r) centerMap(parseFloat(r.lat), parseFloat(r.lon), r.display_name);
      else alert('No se encontr√≥ esa direcci√≥n.');
    } catch { alert('Error al buscar la direcci√≥n.'); }
  });

  // --- Utils
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // --- Pendientes (Supabase)
  function trPendiente({ id, descripcion = "", estado = false } = {}) {
    const tr = document.createElement('tr');
    if (id != null) tr.dataset.id = id;
    tr.innerHTML = `
      <td contenteditable="true">${escapeHtml(descripcion ?? "")}</td>
      <td style="text-align:center;"><input type="checkbox" ${estado ? 'checked' : ''}></td>
      <td style="text-align:center;"><button type="button" onclick="deletePendRow(this)">üóëÔ∏è</button></td>
    `;
    return tr;
  }
  function addPendRow(){ document.querySelector('#pendientesTable tbody').appendChild(trPendiente({ descripcion:"", estado:false })); }
  function deletePendRow(btn){ btn.closest('tr').remove(); }

  async function loadPendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    status.textContent = '‚è≥ Cargando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient.from('pendientes').select('id, descripcion, estado').order('id', { ascending: true });
      if (error) throw error;
      tbody.innerHTML = '';
      data.forEach(item => tbody.appendChild(trPendiente(item)));
      status.textContent = `‚úî ${data.length} tareas`;
    } catch(e){
      err.textContent = 'No se pudieron cargar los pendientes.'; status.textContent = '';
    }
  }
  async function savePendientes(){
    const tbody = document.querySelector('#pendientesTable tbody');
    const status = document.getElementById('pendientesStatus');
    const err = document.getElementById('pendientesError');
    const rows = [...tbody.querySelectorAll('tr')];
    const payload = rows.map(tr => {
      const [tdDesc, tdCheck] = tr.children;
      const id = tr.dataset.id ? Number(tr.dataset.id) : undefined;
      const descripcion = (tdDesc.textContent || '').trim();
      const estado = tdCheck.querySelector('input[type="checkbox"]').checked;
      const obj = { descripcion, estado };
      if (id) obj.id = id;
      return obj;
    });
    status.textContent = 'üíæ Guardando...'; err.textContent = '';
    try {
      const { data, error } = await supabaseClient.from('pendientes').upsert(payload, { onConflict: 'id' }).select('id, descripcion, estado');
      if (error) throw error;
      tbody.innerHTML = ''; data.sort((a,b)=>a.id-b.id).forEach(item => tbody.appendChild(trPendiente(item)));
      status.textContent = '‚úÖ Cambios guardados';
    } catch(e){ err.textContent = 'No se pudieron guardar los cambios.'; status.textContent = ''; }
  }

  // --- Familias (Admin) ‚Äî primero intenta Supabase; si falla, Render (URL absoluta)
  let familiasAdminData = [];
  const famSearch = () => (document.getElementById('fam-search').value || '').trim().toLowerCase();

  function renderFamiliasAdmin(){
    const q = famSearch();
    const tbody = document.querySelector('#familiasAdminTable tbody');
    const rows = (q.length >= 2)
      ? familiasAdminData.filter(f =>
          (f.nombres_apellidos||'').toLowerCase().includes(q) ||
          (f.apellido_familia||'').toLowerCase().includes(q) ||
          (f.direccion||'').toLowerCase().includes(q) ||
          (String(f.dni_solicitante||'')).includes(q))
      : familiasAdminData;

    tbody.innerHTML = '';
    rows.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Nombres">${escapeHtml(f.nombres_apellidos||'')}</td>
        <td data-label="DNI">${escapeHtml(f.dni_solicitante||'')}</td>
        <td data-label="Apellido">${escapeHtml(f.apellido_familia||'')}</td>
        <td data-label="Direcci√≥n">${escapeHtml(f.direccion||'')}</td>
        <td data-label="Fecha">${escapeHtml(f.fecha_registro||'')}</td>
        <td data-label="Tel√©fono">${escapeHtml(f.telefono_contacto||'')}</td>
        <td data-label="Obs.">${escapeHtml(f.observaciones||'')}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('fam-count').textContent = `${rows.length} registro${rows.length===1?'':'s'}`;
  }

  async function loadFamiliasAdmin(){
    const errBox = document.getElementById('familiasAdminError');
    errBox.style.display = 'none';
    familiasAdminData = [];
    try {
      const { data, error } = await supabaseClient
        .from('familias')
        .select('id, nombres_apellidos, dni_solicitante, apellido_familia, direccion, fecha_registro, telefono_contacto, observaciones')
        .order('id', { ascending: true });
      if (error) throw error;
      familiasAdminData = (data || []);
      renderFamiliasAdmin();
      return;
    } catch (e) {
      // Fallback a API en Render (URL absoluta)
    }
    try {
      const res = await fetch('https://api-familias.onrender.com/familias');
      if (!res.ok) throw new Error('API Render error');
      const data = await res.json();
      familiasAdminData = (Array.isArray(data) ? data : (data.items || []))
        .map(x => ({
          nombres_apellidos: x.nombres_apellidos || x.nombres || '',
          dni_solicitante: x.dni_solicitante || x.dni || '',
          apellido_familia: x.apellido_familia || x.apellido || '',
          direccion: x.direccion || '',
          fecha_registro: x.fecha_registro || x.fecha || '',
          telefono_contacto: x.telefono_contacto || x.telefono || '',
          observaciones: x.observaciones || x.obs || ''
        }));
      renderFamiliasAdmin();
    } catch (e) {
      errBox.style.display = 'block';
    }
  }

  document.getElementById('fam-refresh').addEventListener('click', loadFamiliasAdmin);
  document.getElementById('fam-search').addEventListener('input', renderFamiliasAdmin);

  // --- Calendario (JS local + CSS por CDN) con CRUD Supabase
  function mapEventoToFC(row){
    return {
      id: row.id,
      title: row.titulo ?? row.title ?? row.nombre ?? 'Evento',
      start: row.fecha_inicio ?? row.start ?? row.inicio ?? row.fecha ?? row.date,
      end:   row.fecha_fin    ?? row.end   ?? row.fin   ?? null,
      allDay: !!(row.all_day ?? row.allday ?? row.todo_dia ?? false),
    };
  }

  async function fcEventSource(info, success, failure){
    try {
      const cols = 'id, titulo, fecha_inicio, fecha_fin, all_day';
      const { data, error } = await supabaseClient
        .from('eventos')
        .select(cols)
        .order('fecha_inicio', { ascending: true });
      if (error) throw error;
      success((data || []).map(mapEventoToFC));
    } catch (e) {
      console.error('Cargar eventos:', e);
      failure(e);
    }
  }

  // Modal CRUD
  const $modal = document.getElementById('event-modal');
  const $form  = document.getElementById('event-form');
  const $id    = document.getElementById('ev-id');
  const $title = document.getElementById('ev-title');
  const $start = document.getElementById('ev-start');
  const $end   = document.getElementById('ev-end');
  const $all   = document.getElementById('ev-allday');
  const $del   = document.getElementById('ev-delete');
  const $cancel= document.getElementById('ev-cancel');

  function openEventModal({ id=null, title='', start=null, end=null, allDay=false } = {}){
    $id.value = id ?? '';
    $title.value = title ?? '';
    $all.checked = !!allDay;

    const toLocal = (d) => {
      if (!d) return '';
      const dt = (typeof d === 'string') ? new Date(d) : d;
      const off = dt.getTimezoneOffset();
      const dt2 = new Date(dt.getTime() - off*60*1000);
      return dt2.toISOString().slice(0,16);
    };

    $start.value = start ? toLocal(start) : '';
    $end.value   = end   ? toLocal(end)   : '';
    if (allDay && start && typeof start === 'string' && start.length === 10) {
      $start.value = start + 'T00:00';
    }

    $del.style.display = id ? 'inline-block' : 'none';
    $modal.style.display = 'flex';
  }
  function closeEventModal(){ $modal.style.display='none'; $form.reset(); }

  // Guardar (insert/update)
  $form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      titulo: $title.value.trim(),
      all_day: $all.checked,
      fecha_inicio: $start.value ? new Date($start.value).toISOString() : null,
      fecha_fin:    $end.value   ? new Date($end.value).toISOString()   : null
    };

    try {
      if ($id.value) {
        const { error } = await supabaseClient.from('eventos').update(payload).eq('id', Number($id.value));
        if (error) throw error;
      } else {
        const { error } = await supabaseClient.from('eventos').insert([payload]);
        if (error) throw error;
      }
      closeEventModal();
      if (calendarInstance) calendarInstance.refetchEvents();
    } catch (err) {
      alert('No se pudo guardar el evento.');
    }
  });

  // Borrar
  $del.addEventListener('click', async () => {
    if (!$id.value) return;
    if (!confirm('¬øEliminar este evento?')) return;
    try {
      const { error } = await supabaseClient.from('eventos').delete().eq('id', Number($id.value));
      if (error) throw error;
      closeEventModal();
      if (calendarInstance) calendarInstance.refetchEvents();
    } catch (err) {
      alert('No se pudo borrar el evento.');
    }
  });

  // Cancelar / cerrar clic fuera
  $cancel.addEventListener('click', closeEventModal);
  $modal.addEventListener('click', (e) => { if (e.target === $modal) closeEventModal(); });

  // Instancia del calendario
  let calendarInstance = null;
  function initCalendar(){
    const el = document.getElementById('calendar');
    if (!el) return;

    if (calendarInstance) {
      requestAnimationFrame(()=> calendarInstance.render());
      return;
    }

    if (!el.style.minHeight) el.style.minHeight = '520px';

    requestAnimationFrame(() => {
      calendarInstance = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        selectable: true,
        editable: true,
        height: 'auto',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: fcEventSource,

        // Crear por selecci√≥n
        select: (info) => {
          openEventModal({
            title: '',
            start: info.start,
            end: info.end,
            allDay: info.allDay
          });
          calendarInstance.unselect();
        },

        // Editar al hacer clic
        eventClick: (arg) => {
          const e = arg.event;
          openEventModal({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            allDay: e.allDay
          });
        },

        // Arrastrar / redimensionar
        eventChange: async (arg) => {
          const e = arg.event;
          try {
            const { error } = await supabaseClient
              .from('eventos')
              .update({
                fecha_inicio: e.start ? e.start.toISOString() : null,
                fecha_fin:    e.end   ? e.end.toISOString()   : null,
                all_day:      !!e.allDay
              })
              .eq('id', Number(e.id));
            if (error) throw error;
          } catch (err) {
            alert('No se pudo actualizar la fecha del evento.');
            arg.revert();
          }
        }
      });
      calendarInstance.render();
    });
  }

  // --- Inicio
  document.addEventListener('DOMContentLoaded', () => {
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js", { updateViaCache: "none" })
        .then(reg => reg.update().catch(()=>{})).catch(()=>{});
    }
    initMap();

    if (window.firebase && window.firebase.auth) {
      firebase.auth().onAuthStateChanged(user => { updateAuthUI(user); });
    }
  });
  </script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
</body>
</html>
